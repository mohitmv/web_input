<!DOCTYPE html>
<html>
<head>
	<title>web-input</title>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/main.css?reload=8980987987976">
</head>
<body>
<div id="main" style="border: solid #ccc 0px;" ></div>
<script type="text/javascript">
	var py2web = new (function(){
		var thiso = this;
		this.opened_menu = null;//replaced by dropdown-DOM of opened menu.
		this.hide_all_dropdowns = function() {
			if(thiso.opened_menu !== null) {
				thiso.opened_menu.style.visibility = 'hidden';
				thiso.opened_menu = null;
				return true;
			}
			return false;
		}
		this.click_on_menu = function(obj, event) {
			if(!thiso.hide_all_dropdowns()) {
				var icon_position = obj.getBoundingClientRect();
				var dropdown_obj = thiso.opened_menu = obj.nextElementSibling;
				var root_obj = document.body.parentElement;
				
				var directional_margin = [
					icon_position.top-dropdown_obj.clientHeight, 
					root_obj.clientWidth-(icon_position.left+dropdown_obj.clientWidth), 
					root_obj.clientHeight-(icon_position.top+icon_position.height+dropdown_obj.clientHeight), 
					icon_position.left + icon_position.width - dropdown_obj.clientWidth
				];//direction: up, right, down, left

				var directions = [[1, 2], [1, 0], [3, 2], [3, 0]];//(horizonral, vertical)
				var selected_direction = null;
				var min_error = null;
				var min_error_at;
				for(var i=0; i<directions.length; i++) {
					var c1 = directional_margin[directions[i][0]];
					var c2 = directional_margin[directions[i][1]];
					if(c1 >= 0 && c2 >= 0) {
						selected_direction = i;
						break;
					} else {
						var current_error = -1*(c1<0)*c1 + -1*(c2<0)*c2;
						if(min_error === null || current_error < min_error) {
							min_error = current_error;
							min_error_at = i;
						}
					}
				}
				selected_direction = directions[(selected_direction === null ? min_error_at : selected_direction)];
				var directional_postion = [
					icon_position.top-dropdown_obj.clientHeight, 
					icon_position.left, 
					icon_position.top+icon_position.height, 
					icon_position.left + icon_position.width - dropdown_obj.clientWidth
				];// direction: up, right, down, left

				var dropdown_left = directional_postion[selected_direction[0]]+ obj.offsetLeft - icon_position.left;
				var dropdown_top = directional_postion[selected_direction[1]]+ obj.offsetTop - icon_position.top;

				dropdown_obj.style.top = dropdown_top+"px";
				dropdown_obj.style.left = dropdown_left+"px";
				dropdown_obj.style.visibility = "visible";
			}
			event.stopPropagation();
		};


		var get_html = function(design_object) { //assert - design_object is valid.

			var onclick_code = function(onclick_id) {
				return (onclick_id===null ? '': 'onclick="py2web.api_on_click(\''+onclick_id+'\', event)" ');
			}

			var style_code = function(design_object, attrs) {//assert ( attrs <= style_attr_mapping.keys() )
				var style_attr_mapping = {
					valign: "vertical-align", 
					padding: "padding", 
					bgcolor: "background-color", 
					border_width: "border-width", 
					border_color: "border-color", 
					font_size: "font-size", 
					color: "color", 
					line_height: "line-height"
				};

				var output = "";
				for(var i in attrs) {
					if(design_object[attrs[i]]) {
						output += style_attr_mapping[attrs[i]]+':'+design_object[attrs[i]]+";";
					}
				}
				return output;
			}



			var get_text_io_helper = function(design_object) {
				var tag = (design_object.link || design_object.onclick_id) ? "a": "span";
				var font_style_css = "";
				if (design_object.font_style) {
					var font_styles = {
						"i": 'font-style: italic;', 
						'b': 'font-weight: 600;', 
						'u': 'text-decoration: underline;'
					};
					for(var i=0; i<design_object.font_style.length; i++) {
						font_style_css += font_styles[design_object.font_style[i]];
					}
				}
				var output = '<'+tag+' '+(design_object.link ? 'href="'+design_object.link+'" ': '')+' '+onclick_code(design_object.onclick_id)+' style="'+style_code(design_object, ["font_size", "color", "line_height"])+font_style_css+'"  >'+design_object.text;
				for(var i in design_object.children) {
					output += get_text_io_helper(design_object.children[i]);
				}
				output += '</'+tag+'>';
				return output;
			}

			var inputs_objects = thiso.inputs_objects = {};

			var get_html_helper = function(design_object) {
				if (design_object.type === "null") {
					return "";
				} else if(design_object.type === "button") {
					if(design_object.label === null) {
						return '<i '+onclick_code(design_object.onclick_id)+' class="my-material-icon-button" >'+design_object.icon+'</i>';
					} else {
						return '<button class="btn '+(design_object.theme === "black_in_white" ? "btn-default": "btn-primary")+'" '+onclick_code(design_object.onclick_id)+' >'+design_object["label"]+(design_object.icon === null ? '': '<i class="my-material-icons" >'+design_object.icon+'</i>')+ '</button>';
					}
				} else if (design_object.type === "image") {
					return '<img src="'+design_object.src+'" width="'+design_object.width+'" height="'+design_object.height+'" style="opacity: '+design_object.opacity+'; '+(design_object.rounded ? 'border-radius: 50%;': '')+' " >';
				} else if (design_object.type === "text") {
					return '<div class="text_div"  >'+get_text_io_helper(design_object)+'</div>';
				} else if (design_object.type === "icon") {
					return '<i class="my-material-icons" style="font-size: '+design_object.font_size+'" >'+design_object.icon+'</i>';
				} else if (design_object.type === "input") {
					inputs_objects[design_object.id] = design_object;
					if(design_object.input_type === "text") {
						return '<div class="input-div" ><label>'+design_object.label+'</label><br><input id="io_element_'+design_object.id+'" type="text" class="input-input" placeholder="---" ></div>';
					} else if(design_object.input_type === "textarea") {
						return '<div class="input-div" ><label>'+design_object.label+'</label><br><textarea class="input-input" id="io_element_'+design_object.id+'" placeholder="---" rows="'+design_object.default_rows+'" ></textarea></div>';
					} else if(design_object.input_type === "dropdown") {
						var output = '<div class="input-div-select" ><label>'+design_object.label+'</label>'+(design_object.label === "" ? '':'<br>')+'<select class="input-input" id="io_element_'+design_object.id+'" '+(design_object.allow_multiple?'multiple':'')+' >';
						for(var i=0; i<design_object.options.length; i++) {
							var is_selected = design_object.allow_multiple ? (design_object.default_value.indexOf(i+1) != -1) : (i+1 == design_object.default_value);
							output += '<option value="'+(i+1)+'" '+(is_selected ? 'selected':'')+' >'+design_object.options[i]+'</option>';
						}
						output += '</select></div>';
						return output;
					} else if(design_object.input_type === "checkbox") {
						var output = '<div class="input-div" id="io_element_'+design_object.id+'" >'+design_object.label;
						for(var i=0; i<design_object.options.length; i++) {
							var is_selected = design_object.allow_multiple ? (design_object.default_value.indexOf(i+1) != -1) : (i+1 == design_object.default_value);
							output += '<br><label><input name="radio_'+design_object.id+'" type="'+(design_object.allow_multiple ? 'checkbox':'radio')+'" '+(is_selected ? 'checked': '')+' >'+design_object.options[i]+'</label>';
						}
						output += '</div>';
						return output;
					} else {
						return "";
					}

				} else if(design_object.type === "menu") {
					var output = '<span><i class="my-material-icon-button" onclick="py2web.click_on_menu(this, event);" >'+design_object.icon+'</i><div class="dropdown_content_wrapper" ><div class="dropdown_content" >';
					for(var i=0; i<design_object.click_actions.length; i++) {
						output += '<div class="dropdown_elements" '+onclick_code(design_object.click_actions[i][0])+' >'+design_object.click_actions[i][1]+'</div>';
					}
					output += '</div></div></span>';
					return output;
				} else if(design_object.type === "hlist" || design_object.type == "vlist") {
					var output = '<div '+onclick_code(design_object.onclick_id)+' class="'+(design_object.type === "vlist" ? "vertical_table": "table")+ " "+(design_object.onclick_id === null ?'':'hover_cell')+'" '+(design_object.align  ? 'align="'+design_object.align+'"': '')+' style="'+style_code(design_object, ["bgcolor"])+'" >';
					var cell_style = style_code(design_object, ["valign", "border_width", "border_color", "padding"]);
					for(var i=0; i<design_object.children.length; i++) {
						output += '<div class="'+(design_object.type === 'vlist' ? 'vertical_table_cell':'table_cell')+'" style="'+cell_style+(design_object.type == 'vlist' ? 'height': 'width')+':'+design_object[design_object.type === 'vlist' ? 'height' : 'width'][i]+';" >'+get_html_helper(design_object.children[i])+'</div>';
					}
					output += '</div>';
					return output;
				} else {
					return null;
				}
			};
			return get_html_helper(design_object);

		};


		var api_url = "http://127.0.0.1:5018/v1/api";
		var api_call = function(url, data, callback) {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					callback(this.response);
				}
			};
			xhttp.open("POST", url, true);
			xhttp.setRequestHeader("Content-type", "application/json");
			xhttp.send(JSON.stringify(data));
		}

		var render_frame = this.render_frame = function(frame) {
			document.getElementById("main").innerHTML = get_html(frame);
			thiso.set_default_values();
		}


		this.set_default_values = function() {
			for(var i in thiso.inputs_objects) {
				var io = thiso.inputs_objects[i];
				if (io.input_type === 'text' || io.input_type === 'textarea') {
					document.getElementById("io_element_"+io.id).value = io.default_value;
				}
			}
		}

		this.get_input_values = function() {
			var output = {};
			for(var i in thiso.inputs_objects) {
				var io = thiso.inputs_objects[i];
				var dom_elm = document.getElementById("io_element_"+io.id);
				if (io.input_type === 'text' || io.input_type === 'textarea' || (io.input_type === 'dropdown' && !io.allow_multiple)) {
					output[io.id] = dom_elm.value;
					if(io.input_type == "dropdown") {
						output[io.id] = parseInt(output[io.id]);
					}
				} else if(io.input_type === "dropdown" && io.allow_multiple) {
					var selected = [];
					for(var i=0; i<dom_elm.options.length; i++) {
						dom_elm.options[i].selected ? selected.push(i+1):null;
					}
					output[io.id] = selected;
				} else if(io.input_type === "checkbox") {
					var radio_buttons = document.getElementsByName("radio_"+io.id);
					var selected = [];
					for(var i=0; i<radio_buttons.length; i++) {
						radio_buttons[i].checked ? selected.push(i+1):null;
					}
					output[io.id] = io.allow_multiple ? selected: selected[0];
				}

			}
			return output;
		};

		this.api_on_click = function(onclick_id, event) {
			thiso.hide_all_dropdowns();
			console.log("Something got clicked, onclick = "+onclick_id);
			api_call(api_url, {onclick_id: onclick_id, inputs: thiso.get_input_values()}, function(d) {
				render_frame(JSON.parse(d));
			});
			event.stopPropagation();
		}

		this.window_onclick = function() {
			thiso.hide_all_dropdowns();
		}

	})();
	var tmp_frame_6703 = [null, {
		"type": "button", 
		"id": "6",
		"label": "Jai Hind", 
		"theme": "default", 
		"icon": "more_vert", 
		"onclick_id": null, 
	}];
	var initial_frame = tmp_frame_6703[1];
	py2web.render_frame(initial_frame);
	py2web.render_frame
	window.onclick = function(event) {
		py2web.window_onclick();
	}
</script>
</body>
</html>
